#include <stdio.h>
#include <stdint.h>
#include <sleep.h>
uint32_t *control = (uint32_t *) 0x40000000;
int main() {
  *(control) = 0;
  // STEP 3 - commented variable initialisations are to be replaced with a more suitable input data transfer
  // importing adderMode toggle, image, and kernel data
  int adderMode = 0; // 1 to run HW on adder mode, 0 to run HW on max-pooling mode
  int im_h = 28; // image height (vertical pixel length)
  int im_w = 28; // image width (horizontal pixel length)
  int wg_dim = 5; // kernel dimension, make sure this value is positive and less than 8
  int im[784] = {515407872,-98959360,520536064,224313344,154681344,490668032,46399488,-254623744,-529907712,-483131392,187416576,-481230848,293715968,255262720,510738432,226033664,66174976,292405248,95813632,24330240,-260243456,437174272,53264384,355631104,536182784,172261376,23724032,338739200,-298532864,428818432,44449792,510902272,-361234432,-230539264,-260194304,-273711104,250888192,89276416,505036800,456343552,394969088,-103989248,291766272,32735232,-237731840,390086656,120307712,-240435200,-335921152,-483950592,317095936,224624640,-94322688,50167808,-293208064,-435814400,-87359488,-411156480,55263232,-174882816,40468480,322682880,-397918208,-170868736,-280084480,241319936,-510148608,-37978112,-309084160,128466944,-420773888,-357564416,-275873792,-225460224,-243482624,-418168832,-339378176,-9961472,47431680,-521093120,102318080,-451936256,-446906368,-510459904,-96763904,375209984,-158662656,-383238144,353091584,418873344,19120128,-46497792,415940608,140836864,-458555392,448380928,190709760,313769984,-394149888,-126091264,419823616,-220119040,219643904,142196736,-413614080,-270286848,-367575040,-181649408,-233816064,-468942848,-95404032,-223346688,-55558144,-226295808,-241139712,-168280064,257490944,76644352,508952576,132300800,371507200,-146620416,-123355136,-399605760,349601792,355876864,222298112,120750080,127172608,-385024000,194265088,502169600,179044352,291930112,-353746944,-295518208,-351535104,-352305152,-55721984,171245568,-20905984,481722368,150028288,-490799104,121421824,-406814720,-114458624,-150634496,-496746496,-284786688,-272302080,-61210624,427278336,-365707264,-513409024,-323289088,413712384,50282496,-152633344,366002176,296124416,-205471744,-295354368,438648832,231899136,408567808,186204160,519421952,-279379968,391266304,148963328,528596992,-68583424,423313408,204177408,474677248,-16285696,-504201216,256491520,-271187968,-16220160,-125386752,250609664,109150208,381566976,-65110016,494583808,-426541056,200409088,-497303552,-202096640,-108462080,-386465792,396230656,71974912,-24133632,394559488,452263936,-410402816,-515162112,-458719232,-475545600,-413712384,-408502272,-448266240,-326959104,-502890496,12189696,111312896,294551552,-105873408,-51740672,353959936,-380108800,528285696,282705920,44072960,-536051712,330268672,514457600,370343936,-177963008,39092224,89669632,-504463360,-433209344,-130383872,486277120,-252067840,533348352,310280192,183713792,-497647616,-16367616,-246349824,120225792,-461537280,-301350912,-234962944,132431872,-127500288,69042176,-477675520,-141770752,-164003840,167673856,-526663680,-426852352,232701952,-210632704,256655360,164380672,-32538624,401473536,456245248,-158662656,-40009728,202145792,-41975808,1785856,427425792,-271646720,288735232,-80822272,-158334976,-235896832,-19677184,-94027776,375980032,388923392,434814976,-356663296,193544192,486916096,37896192,127221760,-253329408,304267264,-446185472,317898752,-343572480,517013504,-512524288,-258818048,-91455488,-404324352,412844032,-8421376,-458948608,178339840,467763200,38043648,208748544,433291264,-484556800,246906880,-332578816,-154107904,76562432,144506880,-359579648,-421593088,-499400704,387612672,41402368,-339656704,-63406080,-150421504,166330368,24461312,-241729536,414613504,-441466880,-61194240,345669632,429096960,-275103744,423575552,241369088,266240000,402980864,-142786560,-111869952,-438960128,358023168,-60735488,127139840,-91127808,386613248,460455936,-120061952,277594112,449134592,-414515200,106070016,-510951424,-141557760,492601344,-193544192,-71172096,-188121088,-130760704,360546304,-69844992,-347127808,-398688256,-450445312,48889856,259866624,333201408,317210624,230686720,-165363712,528007168,77348864,-130187264,-26984448,-37273600,-358236160,-190496768,378601472,475906048,-105480192,484392960,-49315840,-265404416,-415547392,205029376,-70615040,-227164160,238796800,-315555840,292192256,-434274304,410206208,481148928,-35127296,248283136,125747200,45416448,272777216,-180731904,-231112704,-135823360,-313442304,465567744,255852544,-445333504,268697600,251101184,-21725184,-439418880,-324829184,-465043456,-25378816,461045760,-480690176,-111673344,-334086144,-176881664,286572544,387710976,-232849408,-93192192,-328712192,-304627712,311656448,-244334592,380583936,-466288640,-404553728,171622400,295731200,286244864,-188858368,-449478656,440369152,68075520,-304021504,423788544,-13467648,-64241664,-187023360,130957312,-339902464,6914048,69795840,-410976256,417595392,-317276160,-133709824,-435601408,335872000,-324960256,-517750784,-49332224,-516112384,-114573312,121847808,237993984,372965376,-20840448,-467664896,439009280,-397901824,255459328,-205963264,-263913472,-80838656,-394035200,299368448,-113344512,-187236352,160022528,277938176,-49364992,101154816,-454148096,-368525312,-17481728,-432177152,-120061952,-159842304,105873408,194691072,31506432,-110985216,109461504,-497336320,-573440,-37158912,482607104,-129155072,-386646016,-234291200,144506880,381501440,129597440,-97648640,-461324288,-336101376,273973248,293715968,234274816,250724352,-491831296,396427264,255901696,337215488,-489226240,177913856,65748992,-8339456,502743040,-96894976,37732352,-285802496,-383172608,-133349376,80609280,-7192576,324403200,75792384,338247680,-387776512,-272809984,90734592,521895936,-188301312,450478080,117751808,-137330688,-118063104,514310144,-32440320,-316260352,-181157888,-111198208,527663104,-240566272,191873024,411975680,307363840,304922624,-395214848,-33652736,456785920,-334086144,-115834880,31342592,-413171712,-464109568,-248528896,-499957760,108183552,406224896,-444907520,231817216,308019200,282492928,106086400,-338821120,246300672,32440320,-262422528,439418880,314785792,-2326528,-525467648,506101760,-195788800,-535543808,-124846080,147521536,-462684160,-472809472,-497647616,289456128,93077504,235159552,-403537920,-458981376,350240768,-418136064,-277381120,-320978944,418758656,-223019008,-124747776,466272256,-284557312,-459833344,-515227648,401080320,-224182272,-255213568,467419136,-534577152,173572096,186318848,-245776384,-361168896,-420708352,-246120448,147947520,-39845888,467877888,309608448,527908864,-85016576,-436207616,-398639104,473890816,480411648,-329154560,-134365184,415416320,447348736,-398622720,-238436352,-494370816,82460672,162758656,-302022656,441171968,-148160512,-267124736,273137664,392904704,-317800448,-483868672,-386711552,-263438336,-347389952,87162880,-46399488,86016000,465076224,100352000,182534144,-486686720,203194368,-435716096,465518592,174964736,-223543296,2834432,-175816704,-139788288,524648448,-268402688,172785664,470958080,-85426176,-9256960,4423680,-429162496,-377126912,114245632,399441920,393920512,-227557376,44957696,-474693632,66600960,505036800,-288489472,398606336,-84836352,-295632896,-189677568,309116928,-217628672,489259008,-152190976,-446988288,118571008,-156532736,-451280896,-334741504,241582080,-240631808,313491456,201375744,134479872,113885184,529907712,-222494720,-504053760,-62423040,-384876544,203685888,462143488,462422016,360562688,193871872,57278464,-371441664,61276160,216399872,47579136,-417431552,-300056576,-344293376,-465846272,-1671168,-352256000,376799232,4259840,46366720,-491012096,-507527168,126582784,342360064,309673984,-167673856,-215875584,-394330112,112803840,204800000,292962304,56000512,27525120,-244563968,237617152,300007424,290652160,93995008,-220184576,-406044672,-358350848,-391168000,210468864,-265093120,333234176,142065664,498024448,-115539968,-73695232,160546816,487702528,-70008832,-311574528,390299648,445759488,88391680,470056960,289423360,-339148800,-8585216,-222429184,-493797376,-157073408,-325697536,25018368,-179027968,-118652928,-132677632,388497408,-121618432,-173031424,-182124544,-22740992,-94322688,-467697664,389840896,-46252032,-221052928,-256638976,-153452544,248266752,-92536832,-359661568,-192856064,21069824,-402440192,397869056,-201523200,343179264,-467107840,520257536,-532611072,242073600,-522043392,36487168,-19136512,-13680640,124633088,-114098176,394674176,-19202048,-259538944,-188432384,314900480,179978240,-269402112,-29097984,60030976,-458539008,-363642880,127631360,208257024,-370262016,-168820736}; // image array goes here, format is signed fixed point with radix at 8th (Q7.24), 14 LSBs will be ignored by HW
  int wg[25] = {-270811136,-443531264,-230834176,227966976,194117632,475267072,315801600,-336363520,-216285184,-496730112,-43253760,-150634496,-81690624,-127254528,180617216,-201277440,-81215488,29310976,297566208,536379392,-355647488,-212008960,-48103424,115392512,273301504}; // square kernel array goes here, format is signed fixed point with radix at 8th (Q7.24), 14 LSBs will be ignored by HW
  int out_h = im_h - wg_dim + 1;
  int out_w = im_w - wg_dim + 1;
  int out[out_w * out_h]; // output of this (image, kernel) layer will be stored here, format is signed fixed point with radix at 16th (Q15.16)
  // STEP 4
  int jumps = 8 - wg_dim + 1;
  int out_h_rep = out_h % jumps == 0 ? out_h / jumps : 1 + out_h / jumps; // Math.ceil(out_h / jumps)
  int out_w_rep = out_w % jumps == 0 ? out_w / jumps : 1 + out_w / jumps; // Math.ceil(out_w / jumps)
  // STEP 5
  int count = 0;
  for(count = 0; count < 7 * 7; count++) {
    if(count % 7 < wg_dim && count / 7 < wg_dim) {
      *(control + 65 + count) = wg[wg_dim * (count / 7) + count % 7];
    } else {
      *(control + 65 + count) = 0;
    }
  }
  // STEP 6
  int jumpRight = 0;
  int jumpDown = 0;
  int moveRight = 0;
  int moveDown = 0;
  for(jumpDown = 0; jumpDown < out_h_rep; jumpDown++) {
    for(jumpRight = 0; jumpRight < out_w_rep; jumpRight++) {
      for(moveDown = 0; moveDown < 8; moveDown++) {
        for(moveRight = 0; moveRight < 8; moveRight++) {
          if(jumps * jumpRight + moveRight < im_w && jumps * jumpDown + moveDown < im_h) {
            *(control + 1 + 8 * moveDown + moveRight) = im[im_w * (jumps * jumpDown + moveDown) + (jumps * jumpRight + moveRight)];
          } else {
            *(control + 1 + 8 * moveDown + moveRight) = 0;
          }
        }
      }
      if(adderMode == 1) {
        *(control) = 0xffffffff;// turn on all the bits to enable adder mode
      } else {
        *(control) = 0x007fffff; // turn off the first 9 bits to enable max-pooling mode
      }
      usleep(1); // sleep length is mostly determined by HW specifications and performance (added 10% extra time as buffer)
      *(control) = 0;
      for(moveDown = 0; moveDown < jumps; moveDown++) {
        for(moveRight = 0; moveRight < jumps; moveRight++) {
          if(jumps * jumpRight + moveRight < out_w && jumps * jumpDown + moveDown < out_h) {
            out[out_w * (jumps * jumpDown + moveDown) + (jumps * jumpRight + moveRight)] = (int)*(control + 114 + 8 * moveDown + moveRight);
          }
        }
      }
    }
  }
  // STEP 7 - at this point, output of the (image, kernel) layer is in out[]
  if (adderMode == 1) {
    printf("adder_result = [\n");
  } else {
    printf("compare_result = [\n");
  }
  for(count = 0; count < out_w * out_h; count++) {
    printf("%f,\n", (double) ((int) (out[count])) / 65536);
  }
  printf("]\n");
}
